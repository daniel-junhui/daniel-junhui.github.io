<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> 6.S081 随记 | 橘子屋</title>
  <meta name="description" content="A spec of dust who is trying to learning Computer Science. I hate useless involution and want to seek my own area. ">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="6.S081 随记" />
<meta property="og:description" content="因为其实一直都没有好好读过 OSTEP，所以我在最近一周一口气把这本书读完了，但还是感觉不够，因为我知道要学会这玩意必须要 make hands dirty。于是准备快速的把 6.S081 过完，然后把 lab 做掉，再配合读 xv6 的代码。
System call Syscall system call 第一个 lab 没什么好记录的，只不过用 system call 小打小闹而已，从第二个 lab 开始才是真的对 kernel 做事情。
遇到的一些疑问   英语太垃，看不懂这句话：
 Add a sys_trace() function in kernel/sysproc.c that implements the new system call by remembering its argument in a new variable in the proc structure (see kernel/proc.h). The functions to retrieve system call arguments from user space are in kernel/syscall.c, and you can see examples of their use in kernel/sysproc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhujunhui.com/posts/6.s081/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-15T15:51:07&#43;08:00" />
<meta property="article:modified_time" content="2021-07-15T15:51:07&#43;08:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="6.S081 随记"/>
<meta name="twitter:description" content="因为其实一直都没有好好读过 OSTEP，所以我在最近一周一口气把这本书读完了，但还是感觉不够，因为我知道要学会这玩意必须要 make hands dirty。于是准备快速的把 6.S081 过完，然后把 lab 做掉，再配合读 xv6 的代码。
System call Syscall system call 第一个 lab 没什么好记录的，只不过用 system call 小打小闹而已，从第二个 lab 开始才是真的对 kernel 做事情。
遇到的一些疑问   英语太垃，看不懂这句话：
 Add a sys_trace() function in kernel/sysproc.c that implements the new system call by remembering its argument in a new variable in the proc structure (see kernel/proc.h). The functions to retrieve system call arguments from user space are in kernel/syscall.c, and you can see examples of their use in kernel/sysproc."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://zhujunhui.com/css/style-light.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://zhujunhui.com/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/about">About</a></li>
         
        <li><a href="/anti-involution/">反内卷自动分组工具</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://zhujunhui.com/posts/one-night-in-beijing/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&text=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&title=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&is_video=false&description=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=6.S081%20%e9%9a%8f%e8%ae%b0&body=Check out this article: https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&title=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&title=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&name=6.S081%20%e9%9a%8f%e8%ae%b0&description=%e5%9b%a0%e4%b8%ba%e5%85%b6%e5%ae%9e%e4%b8%80%e7%9b%b4%e9%83%bd%e6%b2%a1%e6%9c%89%e5%a5%bd%e5%a5%bd%e8%af%bb%e8%bf%87%20OSTEP%ef%bc%8c%e6%89%80%e4%bb%a5%e6%88%91%e5%9c%a8%e6%9c%80%e8%bf%91%e4%b8%80%e5%91%a8%e4%b8%80%e5%8f%a3%e6%b0%94%e6%8a%8a%e8%bf%99%e6%9c%ac%e4%b9%a6%e8%af%bb%e5%ae%8c%e4%ba%86%ef%bc%8c%e4%bd%86%e8%bf%98%e6%98%af%e6%84%9f%e8%a7%89%e4%b8%8d%e5%a4%9f%ef%bc%8c%e5%9b%a0%e4%b8%ba%e6%88%91%e7%9f%a5%e9%81%93%e8%a6%81%e5%ad%a6%e4%bc%9a%e8%bf%99%e7%8e%a9%e6%84%8f%e5%bf%85%e9%a1%bb%e8%a6%81%20make%20hands%20dirty%e3%80%82%e4%ba%8e%e6%98%af%e5%87%86%e5%a4%87%e5%bf%ab%e9%80%9f%e7%9a%84%e6%8a%8a%206.S081%20%e8%bf%87%e5%ae%8c%ef%bc%8c%e7%84%b6%e5%90%8e%e6%8a%8a%20lab%20%e5%81%9a%e6%8e%89%ef%bc%8c%e5%86%8d%e9%85%8d%e5%90%88%e8%af%bb%20xv6%20%e7%9a%84%e4%bb%a3%e7%a0%81%e3%80%82%0aSystem%20call%20Syscall%20system%20call%20%e7%ac%ac%e4%b8%80%e4%b8%aa%20lab%20%e6%b2%a1%e4%bb%80%e4%b9%88%e5%a5%bd%e8%ae%b0%e5%bd%95%e7%9a%84%ef%bc%8c%e5%8f%aa%e4%b8%8d%e8%bf%87%e7%94%a8%20system%20call%20%e5%b0%8f%e6%89%93%e5%b0%8f%e9%97%b9%e8%80%8c%e5%b7%b2%ef%bc%8c%e4%bb%8e%e7%ac%ac%e4%ba%8c%e4%b8%aa%20lab%20%e5%bc%80%e5%a7%8b%e6%89%8d%e6%98%af%e7%9c%9f%e7%9a%84%e5%af%b9%20kernel%20%e5%81%9a%e4%ba%8b%e6%83%85%e3%80%82%0a%e9%81%87%e5%88%b0%e7%9a%84%e4%b8%80%e4%ba%9b%e7%96%91%e9%97%ae%20%20%20%e8%8b%b1%e8%af%ad%e5%a4%aa%e5%9e%83%ef%bc%8c%e7%9c%8b%e4%b8%8d%e6%87%82%e8%bf%99%e5%8f%a5%e8%af%9d%ef%bc%9a%0a%20Add%20a%20sys_trace%28%29%20function%20in%20kernel%2fsysproc.c%20that%20implements%20the%20new%20system%20call%20by%20remembering%20its%20argument%20in%20a%20new%20variable%20in%20the%20proc%20structure%20%28see%20kernel%2fproc.h%29.%20The%20functions%20to%20retrieve%20system%20call%20arguments%20from%20user%20space%20are%20in%20kernel%2fsyscall.c%2c%20and%20you%20can%20see%20examples%20of%20their%20use%20in%20kernel%2fsysproc." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&t=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#system-call">System call</a>
      <ul>
        <li><a href="#syscall-system-call">Syscall system call</a></li>
        <li><a href="#risc-v-系统调用的一些规则摘录">RISC-V 系统调用的一些规则摘录</a></li>
        <li><a href="#sysinfo-system-call">Sysinfo system call</a></li>
      </ul>
    </li>
    <li><a href="#page-table">Page table</a>
      <ul>
        <li><a href="#每个进程的-kernel-page-table">每个进程的 kernel page table</a></li>
      </ul>
    </li>
    <li><a href="#trap">Trap</a>
      <ul>
        <li><a href="#用户空间下的-trap">用户空间下的 trap</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        6.S081 随记
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2021-07-15 15:51:07 &#43;0800 &#43;0800" itemprop="datePublished">2021-07-15</time>
          
        </div>
        
        
        
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>因为其实一直都没有好好读过 OSTEP，所以我在最近一周一口气把这本书读完了，但还是感觉不够，因为我知道要学会这玩意必须要 make hands dirty。于是准备快速的把 6.S081 过完，然后把 lab 做掉，再配合读 xv6 的代码。</p>
<h2 id="system-call">System call</h2>
<h3 id="syscall-system-call">Syscall system call</h3>
<p>第一个 lab 没什么好记录的，只不过用 system call 小打小闹而已，从第二个 lab 开始才是真的对 kernel 做事情。</p>
<h4 id="遇到的一些疑问">遇到的一些疑问</h4>
<ul>
<li>
<p>英语太垃，看不懂这句话：</p>
<blockquote>
<p>Add a <code>sys_trace()</code> function in <code>kernel/sysproc.c</code> that implements the new system call by remembering its argument in a new variable in the proc structure (see <code>kernel/proc.h</code>). The functions to retrieve system call arguments from user space are in <code>kernel/syscall.c</code>, and you can see examples of their use in <code>kernel/sysproc.c</code>.</p>
</blockquote>
</li>
</ul>
<p>龙鸣翻译：要加一个新的函数，这个函数通过在 <code>proc</code> 结构中增加的一个新的变量来实现系统调用，从用户空间拿到系统调用参数的函数在 <code>syscall.c</code> 中。确实没怎么看懂，那就先看看代码。</p>
<p>一个很关键的汇编文件：<code>usys.S</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>sleep:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span> li a7, SYS_sleep
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span> ecall
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span> ret
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>.global uptime
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>uptime:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span> li a7, SYS_uptime
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span> ecall
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span> ret
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>.global trace
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>trace:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span> li a7, SYS_trace
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span> ecall
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span> ret
</code></pre></div><p>这个文件可以看到调用 system call 的一些指令，其中 <code>a7</code> 是 RISC-V 的一个寄存器，再看 <code>kernel/syscall.c</code> 当中的一个关键的函数：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#458;font-weight:bold">void</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#900;font-weight:bold">syscall</span>(<span style="color:#458;font-weight:bold">void</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  <span style="color:#458;font-weight:bold">int</span> num;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#000;font-weight:bold">struct</span> proc <span style="color:#000;font-weight:bold">*</span>p <span style="color:#000;font-weight:bold">=</span> myproc();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  num <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">-&gt;</span>trapframe<span style="color:#000;font-weight:bold">-&gt;</span>a7;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#000;font-weight:bold">if</span>(num <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> num <span style="color:#000;font-weight:bold">&lt;</span> NELEM(syscalls) <span style="color:#000;font-weight:bold">&amp;&amp;</span> syscalls[num]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    p<span style="color:#000;font-weight:bold">-&gt;</span>trapframe<span style="color:#000;font-weight:bold">-&gt;</span>a0 <span style="color:#000;font-weight:bold">=</span> syscalls[num]();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  } <span style="color:#000;font-weight:bold">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    printf(<span style="color:#d14">&#34;%d %s: unknown sys call %d</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            p<span style="color:#000;font-weight:bold">-&gt;</span>pid, p<span style="color:#000;font-weight:bold">-&gt;</span>name, num);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    p<span style="color:#000;font-weight:bold">-&gt;</span>trapframe<span style="color:#000;font-weight:bold">-&gt;</span>a0 <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>}
</code></pre></div><p>这个函数应该就是用户态和系统调用的接口，首先获取当前进程的 <code>a7</code> 寄存器，如果这个寄存器中的系统调用号存在（也就是 <code>num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num] </code>语句为真），那就调用它并返回（把 <code>a0</code> 寄存器设置为返回值），否则就返回 <code>-1</code> 。</p>
<p>递归学习：看不太懂下面这个函数指针数组到底是什么玩意：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#000;font-weight:bold">static</span> <span style="color:#900;font-weight:bold">uint64</span> (<span style="color:#000;font-weight:bold">*</span>syscalls[])(<span style="color:#458;font-weight:bold">void</span>) <span style="color:#000;font-weight:bold">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>[SYS_fork]    sys_fork,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>[SYS_exit]    sys_exit,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>[SYS_wait]    sys_wait,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>[SYS_pipe]    sys_pipe,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>[SYS_read]    sys_read,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>[SYS_kill]    sys_kill,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>[SYS_exec]    sys_exec,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>[SYS_fstat]   sys_fstat,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>[SYS_chdir]   sys_chdir,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>[SYS_dup]     sys_dup,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>[SYS_getpid]  sys_getpid,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>[SYS_sbrk]    sys_sbrk,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>[SYS_sleep]   sys_sleep,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>[SYS_uptime]  sys_uptime,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>[SYS_open]    sys_open,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>[SYS_write]   sys_write,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>[SYS_mknod]   sys_mknod,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>[SYS_unlink]  sys_unlink,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>[SYS_link]    sys_link,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>[SYS_mkdir]   sys_mkdir,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>[SYS_close]   sys_close,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>};
</code></pre></div><p>其实就是看不懂 <code>uint64 (*syscalls[])(void)</code> 的意思，参考之前知乎上看到的一个回答，把这个东西翻译成英文：
an array of pointers to a function that returns uint64，也就是一个函数指针的数组，这个初始化的方式也确实给我整麻了，但无所谓看懂了就行，不纠结语法。</p>
<p>其实还有一个终极问题：当调用系统调用的时候，真正的流程到底是什么？很遗憾这可能需要用 gdb 目力调试才能知道，但其实在不知道这个事情的流程下也能够完成这个实验，只需要观察一下 <code>sys_exit</code> 的代码：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>uint64
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#900;font-weight:bold">sys_exit</span>(<span style="color:#458;font-weight:bold">void</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  <span style="color:#458;font-weight:bold">int</span> n;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  <span style="color:#000;font-weight:bold">if</span>(argint(<span style="color:#099">0</span>, <span style="color:#000;font-weight:bold">&amp;</span>n) <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>  exit(n);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;  <span style="color:#998;font-style:italic">// not reached
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span><span style="color:#998;font-style:italic"></span>}
</code></pre></div><p>它调用了 <code>argint(0, &amp;n)</code> 来获取了进程退出时的状态号，再看到 <code>syscall.c</code> 中对于 <code>argint</code> 函数的注释：<code>// Fetch the nth 32-bit system call argument.</code> 就可以知道这个函数就是用来获取系统调用的参数的，那直接先拿来用就好了（拿来主义）。</p>
<p>最终增加的关键代码如下：（还有一些杂七杂八的东西要加，比如系统调用的打印）</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>uint64
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#900;font-weight:bold">sys_trace</span>(<span style="color:#458;font-weight:bold">void</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  uint mask;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  <span style="color:#000;font-weight:bold">if</span>(argint(<span style="color:#099">0</span>, (<span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>)<span style="color:#000;font-weight:bold">&amp;</span>mask) <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>  myproc()<span style="color:#000;font-weight:bold">-&gt;</span>trace_mask <span style="color:#000;font-weight:bold">=</span> mask;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>}
</code></pre></div><h3 id="risc-v-系统调用的一些规则摘录">RISC-V 系统调用的一些规则摘录</h3>
<ul>
<li>syscall number is passed in <code>a7</code></li>
<li>syscall arguments are passed in <code>a0</code> to <code>a5</code></li>
<li>unused arguments are set to <code>0</code></li>
<li>return value is returned in <code>a0</code></li>
</ul>
<h3 id="sysinfo-system-call">Sysinfo system call</h3>
<p>差不多和前面的 system call 一样，需要把一些信息拷贝到 user 空间，要用到 <code>copyout()</code> 函数。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#998;font-style:italic">// Copy from kernel to user.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#998;font-style:italic">// Copy len bytes from src to virtual address dstva in a given page table.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#998;font-style:italic">// Return 0 on success, -1 on error.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#998;font-style:italic"></span><span style="color:#458;font-weight:bold">int</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#900;font-weight:bold">copyout</span>(pagetable_t pagetable, uint64 dstva, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>src, uint64 len)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  uint64 n, va0, pa0;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#000;font-weight:bold">while</span>(len <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    va0 <span style="color:#000;font-weight:bold">=</span> PGROUNDDOWN(dstva);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    pa0 <span style="color:#000;font-weight:bold">=</span> walkaddr(pagetable, va0);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#000;font-weight:bold">if</span>(pa0 <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>      <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    n <span style="color:#000;font-weight:bold">=</span> PGSIZE <span style="color:#000;font-weight:bold">-</span> (dstva <span style="color:#000;font-weight:bold">-</span> va0);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#000;font-weight:bold">if</span>(n <span style="color:#000;font-weight:bold">&gt;</span> len)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>      n <span style="color:#000;font-weight:bold">=</span> len;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    memmove((<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>)(pa0 <span style="color:#000;font-weight:bold">+</span> (dstva <span style="color:#000;font-weight:bold">-</span> va0)), src, n);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    len <span style="color:#000;font-weight:bold">-=</span> n;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    src <span style="color:#000;font-weight:bold">+=</span> n;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    dstva <span style="color:#000;font-weight:bold">=</span> va0 <span style="color:#000;font-weight:bold">+</span> PGSIZE;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>}
</code></pre></div><p>其实也很简单，直接拿到当前进程的 pagetable，然后虚拟地址其实就是第一个参数，其他的直接传进去用就好了。</p>
<p>至于活跃进程数量和空闲内存数：</p>
<ul>
<li>xv6 中的进程比较简单，是一个固定的数组（64个）。遍历一遍，剔除 <code>UNUSED</code> 的数量就好了；</li>
<li>先获取空闲的页数，然后乘以 4K 就可以得到空闲字节数。</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>uint64
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#900;font-weight:bold">sys_sysinfo</span>(<span style="color:#458;font-weight:bold">void</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  <span style="color:#998;font-style:italic">// printf(&#34;hello\n&#34;);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">struct</span> sysinfo info;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  uint64 user_addr;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  <span style="color:#000;font-weight:bold">struct</span> proc <span style="color:#000;font-weight:bold">*</span>p <span style="color:#000;font-weight:bold">=</span> myproc();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#000;font-weight:bold">if</span>(argaddr(<span style="color:#099">0</span>, <span style="color:#000;font-weight:bold">&amp;</span>user_addr) <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  info.freemem <span style="color:#000;font-weight:bold">=</span> free_memory_number();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  info.nproc <span style="color:#000;font-weight:bold">=</span> process_number();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#000;font-weight:bold">if</span>(copyout(p<span style="color:#000;font-weight:bold">-&gt;</span>pagetable, user_addr, (<span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>)<span style="color:#000;font-weight:bold">&amp;</span>info, <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#000;font-weight:bold">struct</span> sysinfo))<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#099">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>}
</code></pre></div><h2 id="page-table">Page table</h2>
<h3 id="每个进程的-kernel-page-table">每个进程的 kernel page table</h3>
<p>说实话，做到这一步的时候，我很莫名其妙为什么要去修改内核的这个机制，也就是「内核拥有一个自己的页表」机制。</p>
<p>读了一下 xv6 的 rec-book，这个 lab 的意思大致就是因为 xv6 的内核采用的是 direct-mapping 机制，所以可以让「内核拥有一个自己的页表」，但这样的话在运行内核代码的时候，就要用一个「转换机制」来访问用户的数据，接下来几个事情就是为了改变这个事情，至于改了之后到底有什么好处，我也不知道，做了再说。</p>
<p>大致的思路是这样：</p>
<ul>
<li>首先是需要给每个 process 维护一个 kernel_pagetable 域。</li>
<li>需要给每个 process 创建时（也就是在函数 <code>allocproc</code> 中）填充这个 process 的 kernel_pagetable ，目前来说每个进程的内核页表是和内核独有的页表是一模一样的。</li>
<li>除了上面和内核独有页表的内容一样以外，每个进程都要在自己的页表里再增加自己的内核 stack 映射。而这个映射原本在未修改的 xv6 中是由内核提前为所有的预备进程做好的（ <code>procinit</code> 函数），现在需要把这个事情延迟到在每个进程被创建的时候再做。</li>
<li>在调度函数中确保在切换到某个进程的之前，使用该进程的内核页表（也就是在 <code>swtch(&amp;c-&gt;context, &amp;p-&gt;context)</code> 之前），在重新回到调度程序后，再切换回内核自己的页表。</li>
<li>在进程被 free 的时候，顺便把 kernel_pagetable 也删了，但不用删除页表的叶结点，只需要删前两层的索引。</li>
</ul>
<p>在差不多做完这些事情后，还遇到了一些问题。</p>
<ol>
<li>改完之后 <code>make qemu</code> 直接报 <code>panic: kvmpa</code> 。</li>
</ol>
<p><code>kvmpa</code> 函数的用处是「将内核的一个虚拟地址转换为一个物理地址」，而 xv6 的内核地址大多都是 direct-mapping 的，换言之其实就是转换内核栈的地址而已，而在改完之后，进程的内核栈的地址已经不属于内核的页表了，而属于每个进程自己的内核页表，因此需要修改 <code>pte = walk(kernel_pagetable, va, 0)</code> 为 <code>pte = walk(myproc()-&gt;kernel_pagetable, va, 0)</code> 。（调用 <code>myproc()</code> 需要加两个头文件）</p>
<ol start="2">
<li>进程内核栈的内存泄漏问题</li>
</ol>
<p>要注意，每个进程被 free 的时候，即使不用释放进程内核页表绝大多数的叶子 page ，但是进程内核栈的 page 是必须要释放的，不然跑 usertests 的时候会在 sbrkfail 处报 kvmmap 的 panic ，我没有用 gdb 去调试出到底出了什么差错。但在我添加了对内核栈的手动释放后，就不报错了，所以很大可能的原因就是内存泄漏了，每当创建一个进程就浪费掉 1 个 page，free 的时候又不回收，最后就导致内存用尽没得用了。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>  <span style="color:#000;font-weight:bold">if</span>(p<span style="color:#000;font-weight:bold">-&gt;</span>kstack)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    uvmunmap(p<span style="color:#000;font-weight:bold">-&gt;</span>kernel_pagetable, p<span style="color:#000;font-weight:bold">-&gt;</span>kstack, <span style="color:#099">1</span>, <span style="color:#099">1</span>); 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  p<span style="color:#000;font-weight:bold">-&gt;</span>kstack <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  <span style="color:#000;font-weight:bold">if</span>(p<span style="color:#000;font-weight:bold">-&gt;</span>kernel_pagetable)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>    proc_freekernelpagetable(p<span style="color:#000;font-weight:bold">-&gt;</span>kernel_pagetable);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  p<span style="color:#000;font-weight:bold">-&gt;</span>kernel_pagetable <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
</code></pre></div><h2 id="trap">Trap</h2>
<p>一些关键的寄存器：</p>
<ul>
<li><code>stvec</code> 用于存储 trap handler 的地址，由内核写入</li>
<li><code>sepc</code> 来保存进入 trap 前的 <code>pc</code></li>
<li><code>scause</code> 保存 trap 的原因</li>
<li><code>sccratch</code> 在调用 trap handler 的时候会用到这个寄存器</li>
<li><code>sstatus</code> 中的 SIE 位表示是否阻塞设备中断，SPP 位表示 trap 来自于用户态还是内核态</li>
</ul>
<p>当 RISC-V CPU 要开始一个 trap 的时候依次做如下的事情：</p>
<ol>
<li>如果是一个设备终端且 <code>sstatus</code> 中的 SIE 位是空的，就不往下走了；</li>
<li>清楚 SIE 位（保证原子性）；</li>
<li>将当前的 <code>pc</code> 复制到 <code>sepc</code> ；</li>
<li>将当前的 mode 复制到 <code>sstatus</code> 的 SPP 位；</li>
<li>设置 <code>scause</code>；</li>
<li>将 mode 设置为 supervisor mode；</li>
<li>将 <code>stvec</code> 复制到 <code>pc</code> ；</li>
<li>go on 运行指令。</li>
</ol>
<h3 id="用户空间下的-trap">用户空间下的 trap</h3>
<p>流程是</p>
<ol>
<li><code>trampoline.S</code> 中的 <code>uservec</code> 函数，这个函数被 <code>stvec</code> 所指</li>
<li>转到 <code>trap.c</code> 中的 <code>usertrap</code> 函数</li>
<li>trap 结束后转到 <code>trap.c</code> 中的 <code>usertrapret</code> 函数</li>
<li>然后转到 <code>trampoline.S</code> 中的 <code>userret</code> 函数</li>
</ol>
<p>首先，硬件并不会在发生 trap 时切换页表，因此用户的页表需要存在一个虚拟地址映射到 <code>uservec</code> ；同时 <code>uservec</code> 函数必须显示将 <code>satp</code> 切换到内核的页表（不然不能直接访问物理内存）。xv6 用了一个 <code>trampoline</code> 页来映射 <code>trampoline.S</code> 的代码，并且不管是用户空间还是内核空间，虚拟地址都是一样的。</p>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/anti-involution/">反内卷自动分组工具</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#system-call">System call</a>
      <ul>
        <li><a href="#syscall-system-call">Syscall system call</a></li>
        <li><a href="#risc-v-系统调用的一些规则摘录">RISC-V 系统调用的一些规则摘录</a></li>
        <li><a href="#sysinfo-system-call">Sysinfo system call</a></li>
      </ul>
    </li>
    <li><a href="#page-table">Page table</a>
      <ul>
        <li><a href="#每个进程的-kernel-page-table">每个进程的 kernel page table</a></li>
      </ul>
    </li>
    <li><a href="#trap">Trap</a>
      <ul>
        <li><a href="#用户空间下的-trap">用户空间下的 trap</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&text=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&title=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&is_video=false&description=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=6.S081%20%e9%9a%8f%e8%ae%b0&body=Check out this article: https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&title=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&title=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&name=6.S081%20%e9%9a%8f%e8%ae%b0&description=%e5%9b%a0%e4%b8%ba%e5%85%b6%e5%ae%9e%e4%b8%80%e7%9b%b4%e9%83%bd%e6%b2%a1%e6%9c%89%e5%a5%bd%e5%a5%bd%e8%af%bb%e8%bf%87%20OSTEP%ef%bc%8c%e6%89%80%e4%bb%a5%e6%88%91%e5%9c%a8%e6%9c%80%e8%bf%91%e4%b8%80%e5%91%a8%e4%b8%80%e5%8f%a3%e6%b0%94%e6%8a%8a%e8%bf%99%e6%9c%ac%e4%b9%a6%e8%af%bb%e5%ae%8c%e4%ba%86%ef%bc%8c%e4%bd%86%e8%bf%98%e6%98%af%e6%84%9f%e8%a7%89%e4%b8%8d%e5%a4%9f%ef%bc%8c%e5%9b%a0%e4%b8%ba%e6%88%91%e7%9f%a5%e9%81%93%e8%a6%81%e5%ad%a6%e4%bc%9a%e8%bf%99%e7%8e%a9%e6%84%8f%e5%bf%85%e9%a1%bb%e8%a6%81%20make%20hands%20dirty%e3%80%82%e4%ba%8e%e6%98%af%e5%87%86%e5%a4%87%e5%bf%ab%e9%80%9f%e7%9a%84%e6%8a%8a%206.S081%20%e8%bf%87%e5%ae%8c%ef%bc%8c%e7%84%b6%e5%90%8e%e6%8a%8a%20lab%20%e5%81%9a%e6%8e%89%ef%bc%8c%e5%86%8d%e9%85%8d%e5%90%88%e8%af%bb%20xv6%20%e7%9a%84%e4%bb%a3%e7%a0%81%e3%80%82%0aSystem%20call%20Syscall%20system%20call%20%e7%ac%ac%e4%b8%80%e4%b8%aa%20lab%20%e6%b2%a1%e4%bb%80%e4%b9%88%e5%a5%bd%e8%ae%b0%e5%bd%95%e7%9a%84%ef%bc%8c%e5%8f%aa%e4%b8%8d%e8%bf%87%e7%94%a8%20system%20call%20%e5%b0%8f%e6%89%93%e5%b0%8f%e9%97%b9%e8%80%8c%e5%b7%b2%ef%bc%8c%e4%bb%8e%e7%ac%ac%e4%ba%8c%e4%b8%aa%20lab%20%e5%bc%80%e5%a7%8b%e6%89%8d%e6%98%af%e7%9c%9f%e7%9a%84%e5%af%b9%20kernel%20%e5%81%9a%e4%ba%8b%e6%83%85%e3%80%82%0a%e9%81%87%e5%88%b0%e7%9a%84%e4%b8%80%e4%ba%9b%e7%96%91%e9%97%ae%20%20%20%e8%8b%b1%e8%af%ad%e5%a4%aa%e5%9e%83%ef%bc%8c%e7%9c%8b%e4%b8%8d%e6%87%82%e8%bf%99%e5%8f%a5%e8%af%9d%ef%bc%9a%0a%20Add%20a%20sys_trace%28%29%20function%20in%20kernel%2fsysproc.c%20that%20implements%20the%20new%20system%20call%20by%20remembering%20its%20argument%20in%20a%20new%20variable%20in%20the%20proc%20structure%20%28see%20kernel%2fproc.h%29.%20The%20functions%20to%20retrieve%20system%20call%20arguments%20from%20user%20space%20are%20in%20kernel%2fsyscall.c%2c%20and%20you%20can%20see%20examples%20of%20their%20use%20in%20kernel%2fsysproc." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fzhujunhui.com%2fposts%2f6.s081%2f&t=6.S081%20%e9%9a%8f%e8%ae%b0" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  zhu 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/about">About</a></li>
         
        <li><a href="/anti-involution/">反内卷自动分组工具</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
